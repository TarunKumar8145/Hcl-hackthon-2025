{% extends "base.html" %}

{% block title %}SmartBank - Money Transfer{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-paper-plane"></i> Money Transfer</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <form id="transferForm">
                            <div class="mb-3">
                                <label for="from_account" class="form-label">From Account</label>
                                <select class="form-select" id="from_account" name="from_account" required>
                                    <option value="">Select Account</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="to_account" class="form-label">To Account Number</label>
                                <input type="text" class="form-control" id="to_account" name="to_account" 
                                       placeholder="Enter recipient account number" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount (₹)</label>
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       min="1" step="0.01" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">Description (Optional)</label>
                                <input type="text" class="form-control" id="description" name="description" 
                                       placeholder="Payment description">
                            </div>
                            
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Transfer Limits:</h6>
                                <ul class="mb-0">
                                    <li>Savings Account: ₹50,000 per day</li>
                                    <li>Current Account: ₹1,00,000 per day</li>
                                    <li>Transfers are processed instantly</li>
                                </ul>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Transfer Money
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Transfer Status</h5>
                        <div id="transferStatus">
                            <p class="text-muted">Ready to transfer money between accounts.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transfer Successful!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transferDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="window.location.reload()">
                    Make Another Transfer
                </button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/dashboard'">
                    Go to Dashboard
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const token = localStorage.getItem('access_token');
if (!token) window.location.href = '/login';

// Load user accounts for dropdown
async function loadUserAccounts() {
    try {
        const response = await fetch('/api/accounts', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const accounts = await response.json();
            const select = document.getElementById('from_account');
            
            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.account_number;
                option.textContent = `${account.account_type} - ${account.account_number} (₹${parseFloat(account.balance).toFixed(2)})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading accounts:', error);
    }
}

// Load recent transactions
async function loadTransactions() {
    try {
        const response = await fetch('/api/transactions', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const transactions = await response.json();
            const container = document.getElementById('transactionsList');
            
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-muted">No transactions found.</p>';
            } else {
                let html = '';
                transactions.forEach(txn => {
                    const date = new Date(txn.created_at).toLocaleDateString();
                    html += `
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-muted">${txn.transaction_id}</small>
                                        <br><small>${date}</small>
                                    </div>
                                    <div class="text-end">
                                        <strong class="text-success">₹${parseFloat(txn.amount).toFixed(2)}</strong>
                                        <br><small class="text-muted">${txn.status}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
    }
}

// Handle transfer form submission
document.getElementById('transferForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/api/transfer', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            
            document.getElementById('transferDetails').innerHTML = `
                <p><strong>Transaction ID:</strong> ${result.transaction_id}</p>
                <p><strong>Amount:</strong> ₹${result.amount}</p>
                <p><strong>From:</strong> ${result.from_account}</p>
                <p><strong>To:</strong> ${result.to_account}</p>
                <p><strong>New Balance:</strong> ₹${result.new_balance.toFixed(2)}</p>
                <p class="text-success">Transfer completed successfully!</p>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        } else {
            const error = await response.json();
            alert('Transfer failed: ' + error.detail);
        }
    } catch (error) {
        alert('Transfer failed: ' + error.message);
    }
});

// Load data on page load
loadUserAccounts();
</script>
{% endblock %}
